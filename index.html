<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Shica WASM Click & Timer Integration Demo</title>

  <!-- ACE Editor -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.0/ace.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.0/mode-c_cpp.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.0/theme-textmate.min.js"></script>

  <style>
    body { display: flex; margin: 0; height: 100vh; font-family: sans-serif; }
    #left, #right { flex: 1; overflow: auto; }
    #map { position: relative; width: 100%; height: 600px; background: #222; }
    .ghost { position: absolute; width: 50px; height: 50px; font-size: 50px; line-height: 50px; text-align: center; }
    #info { background: #fff; padding: 10px; font-size: 14px; }
    #editor { width: 100%; height: 300px; }
    button { margin: 5px; padding: 10px 20px; }
    pre { background: #eee; padding: 10px; }
  </style>
</head>
<body>

  <div id="left">
    <div id="map">
      <div class="ghost" id="ghost1" style="left:100px; top:100px;">ðŸ‘»</div>
    </div>
    <div id="info">Agent data will appear here</div>
    <div id="clickInfo">Click on the map to send data</div>
    <div id="timerInfo">Timer data will be sent to C code</div>
  </div>

  <div id="right">
    <h1>Shica WASM Click & Timer Integration</h1>
    <div id="editor"></div>
    <button id="compileBtn">Compile</button>
    <button id="runBtn">Run</button>
    <pre id="outputIR">IR Output</pre>
    <pre id="outputResult">Execution Result</pre>
  </div>

  <!-- Load WebAssembly Module -->
  <script src="vm.js"></script> <!-- ãƒ“ãƒ«ãƒ‰æ¸ˆã¿jsã‚’æŒ‡å®š -->

  <script>
    const editor = ace.edit("editor");
    editor.session.setMode("ace/mode/c_cpp");
    editor.setTheme("ace/theme/textmate");

    let runInterval = null;
    let timerPtr, clickPtr;
    let agentPtr; 

    Module.onRuntimeInitialized = () => {
      console.log("WASM initialized");

      // memory_init å‘¼ã³å‡ºã—ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
      Module.ccall('memory_init', 'number', [], []);

      // Timer pointer ã‚’å–å¾—
      timerPtr = Module.ccall('initWebTimerPtr', 'number', [], []);
    //   console.log("Timer pointer initialized at:", timerPtr);

      // Click pointer ã‚’å–å¾—
      clickPtr = Module.ccall('initWebClickSTTPtr', 'number', [], []);
    //   console.log("Click pointer initialized at:", clickPtr);

        // AgentData pointer ã‚’å–å¾—
        agentPtr = Module.ccall('initAnAgnetDataPtr', 'number', [], []);
        // console.log("AgentData pointer initialized at:", agentPtr);

      // Compile ãƒœã‚¿ãƒ³
      document.getElementById("compileBtn").addEventListener("click", () => {
        const code = editor.getValue();
        const result = Module.ccall('compileWebCode', 'number', ['string'], [code]);
        document.getElementById("outputIR").textContent = `Compile result: ${result}`;
      });

      // Run ãƒœã‚¿ãƒ³
      document.getElementById("runBtn").addEventListener("click", () => {
        if (runInterval) {
          clearInterval(runInterval);
          runInterval = null;
          document.getElementById("runBtn").textContent = "Run";
          return;
        }

        Module.ccall('initRunWeb', 'number', [], []);
        document.getElementById("runBtn").textContent = "Stop";

        runInterval = setInterval(() => {
          const result = Module.ccall('runWeb', 'number', [], []);
          document.getElementById("outputResult").textContent = `Run result: ${result}`;

          // Timer å€¤ã‚’æ›´æ–°ï¼ˆä¾‹: ç¾åœ¨æ™‚åˆ»ãƒŸãƒªç§’ï¼‰
          const now = Date.now();
          Module.setValue(timerPtr, now, 'i32');

          // Timer å€¤èª­ã¿å–ã‚Šãƒ†ã‚¹ãƒˆ
          const timerVal = Module.getValue(timerPtr, 'i32');
        //   console.log("Timer value:", timerVal);

          // Click ãƒ‡ãƒ¼ã‚¿èª­ã¿å–ã‚Šãƒ†ã‚¹ãƒˆ
          const clickX = Module.getValue(clickPtr + 0, 'i32');
          const clickY = Module.getValue(clickPtr + 4, 'i32');
          const clickStatus = Module.getValue(clickPtr + 8, 'i32');
        //   console.log("Click:", clickX, clickY, clickStatus);

          // AgentData æ§‹é€ ä½“èª­ã¿å–ã‚Šä¾‹
          
        //   console.log("agentPtr:", agentPtr); // 0ã§ã¯ãªã„ã‹ç¢ºèª
          const x = Module.getValue(agentPtr + 0, 'i32');
          const y = Module.getValue(agentPtr + 4, 'i32');

// console.log("HEAP32.length:", Module.HEAP32.length);
// console.log("agentPtr/4:", agentPtr / 4);
// console.log("getValue x,y:", x, y);
// console.log("HEAP32 x,y:", Module.HEAP32[agentPtr / 4], Module.HEAP32[agentPtr / 4 + 1]);

          const vx = Module.getValue(agentPtr + 8, 'i32');
          const vy = Module.getValue(agentPtr + 12, 'i32');
          const isClick = Module.getValue(agentPtr + 16, 'i32');
          const distance = Module.getValue(agentPtr + 20, 'i32');
          const status = Module.getValue(agentPtr + 24, 'i32');

          document.getElementById("info").textContent =
            `x: ${x}, y: ${y}, vx: ${vx}, vy: ${vy}, isClick: ${isClick}, dist: ${distance}, status: ${status}`;

          // ghost position update
          const ghost = document.getElementById("ghost1");
          ghost.style.left = `${x}px`;
          ghost.style.top = `${y}px`;
          // Click position update
          const clickInfo = document.getElementById("clickInfo");
          clickInfo.textContent =
            `Click at (${clickX}, ${clickY}), Status: ${clickStatus ? 'Active' : 'Inactive'}`;
            // Timer info update
            const timerInfo = document.getElementById("timerInfo");
            timerInfo.textContent = `Timer value: ${timerVal}`;

        }, 50);
      });
    };

    // Click ã‚¤ãƒ™ãƒ³ãƒˆ
    const map = document.getElementById("map");

    map.addEventListener("mousedown", (e) => {
      const rect = map.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      // Click data ã‚’ C ã«å…±æœ‰
      Module.setValue(clickPtr + 0, x, 'i32'); // x
      Module.setValue(clickPtr + 4, y, 'i32'); // y
      Module.setValue(clickPtr + 8, 1, 'i32'); // click status active
    });

    window.addEventListener("mouseup", () => {
      Module.setValue(clickPtr + 8, 0, 'i32'); // click status inactive
    });
  </script>

</body>
</html>
